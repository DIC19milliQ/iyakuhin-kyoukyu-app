<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    .old-update-1y { background-color: #a6a6a6; } /* 1å¹´ä»¥ä¸Šå‰ */
    .old-update-2y { background-color: #666666; color: white; } /* 2å¹´ä»¥ä¸Šå‰ */
    .new-update { background-color: #b3e5fc; } /* 1ãƒ¶æœˆä»¥å†… */
    .loading { font-size: 16px; color: gray; display: none; }
    #admin-tab h2 {
      margin: 0;
      padding: 0;
    }

    #admin-tab h3 {
      margin-top: 24px;
      margin-bottom: 10px;
    }

    #admin-tab {
      padding: 10px 20px;
      position: relative;
    }
  </style>
  <script>
    // â˜… Webå…¬é–‹CSVã®URLï¼ˆå…¬è¡¨ã‚·ãƒ¼ãƒˆï¼‰
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhRdIzKcJP_tW-XUSjuHcsIFQVurGQzjoBfRY9kX2yOBhSz_8QBJ019TaF8En7dKfMgNaadBxFfDn1/pub?gid=1113729234&single=true&output=csv";

    // â˜… ãƒ‡ãƒ¼ã‚¿å–å¾—æ–¹å¼ï¼ˆtrue = CSVé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰, false = APIãƒ¢ãƒ¼ãƒ‰ï¼‰
    let useCsvMode = (localStorage.getItem("useCsvMode") ?? "true") === "true";

    const displayLabelMap = {
      i: "æˆåˆ†å",
      y: "YJã‚³ãƒ¼ãƒ‰",
      p: "å“å",
      s: "å‡ºè·çŠ¶æ³",
      u1: "å¤‰æ›´æ—¥",
      r: "ç†ç”±",
      f: "è§£é™¤è¦‹è¾¼ã¿",
      z: "æ™‚æœŸ",
      q: "å‡ºè·é‡",
      u2: "æ›´æ–°æ—¥"
    };

    function normalizeText(text) {
      if (!text) return "";
      return text
        .toLowerCase()
        .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 65248))
        .replace(/[ã‚¡-ãƒ³]/g, c => String.fromCharCode(c.charCodeAt(0) - 96))
        .replace(/[â€â€‘â€’â€“â€”â€•âˆ’ãƒ¼ï¼]/g, "-")
        .replace(/ï¼/g, "/");
    }

    // åšåŠ´çœExcelã®æ›´æ–°æ—¥ï¼ˆAPIã‹ã‚‰1å›ã ã‘å–å¾—ã—ã¦ã“ã“ã«ä¿æŒï¼‰
    let excelUpdateDateRaw = "";

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«1å›ã ã‘ Excelæ›´æ–°æ—¥ã‚’å–å¾—ã—ã¦ã€ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
    function initExcelUpdateDate() {
      const apiUrlForMeta = "https://script.google.com/macros/s/AKfycbzAjXjAoSYkyzvPTymXj_B58nRPN1WqfbR05O_xPHC-3sPAjzHy2_piZlnziOj7S6xo/exec";

      fetch(apiUrlForMeta)
        .then(res => res.json())
        .then(data => {
          const raw = data?.meta?.Excelæ›´æ–°æ—¥ || "";
          excelUpdateDateRaw = raw;

          const el = document.getElementById("excel-date-info");
          if (!el) return;

          if (raw) {
            el.textContent = "åšåŠ´çœExcelã®ãƒ‡ãƒ¼ã‚¿æ—¥: " + formatUpdateDate(raw);
          } else {
            el.textContent = "åšåŠ´çœExcelã®ãƒ‡ãƒ¼ã‚¿æ—¥: ä¸æ˜";
          }
        })
        .catch(err => {
          console.error("Excelæ›´æ–°æ—¥ã®å–å¾—ã«å¤±æ•—:", err);
          const el = document.getElementById("excel-date-info");
          if (el) {
            el.textContent = "åšåŠ´çœExcelã®ãƒ‡ãƒ¼ã‚¿æ—¥: ä¸æ˜";
          }
        });
    }


   // â–¼ æ¤œç´¢å®Ÿè¡Œï¼ˆCSV / API ä¸¡å¯¾å¿œã®å…¥å£ï¼‰
   function fetchData() {
     const searchTerm = document.getElementById("searchInput").value.trim();
     if (!searchTerm) {
       document.getElementById("result").innerHTML = "<p>æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>";
       return;
     }

     document.getElementById("loading").style.display = "block";
     document.getElementById("searchInput").disabled = true;
     document.getElementById("searchButton").disabled = true;

     const words = searchTerm.split(/\s+/).map(normalizeText);

     // â˜… ã“ã“ã§ CSVãƒ¢ãƒ¼ãƒ‰ / APIãƒ¢ãƒ¼ãƒ‰ ã‚’åˆ‡ã‚Šæ›¿ãˆ
     if (useCsvMode) {
       fetchFromCsv(words);
     } else {
       fetchFromApi(words);
     }
   }

   // â–¼ ã‚‚ã¨ã® API æ–¹å¼ï¼ˆç¾è¡Œã©ãŠã‚Šã®å‡¦ç†ã‚’ãã®ã¾ã¾é–¢æ•°åŒ–ï¼‰
   function fetchFromApi(words) {
     const apiUrl = "https://script.google.com/macros/s/AKfycbzAjXjAoSYkyzvPTymXj_B58nRPN1WqfbR05O_xPHC-3sPAjzHy2_piZlnziOj7S6xo/exec";

     fetch(apiUrl)
       .then(response => response.json())
       .then(data => {
         finalizeLoadingState();

         if (data.error) {
           document.getElementById("result").innerHTML = "<p>ã‚¨ãƒ©ãƒ¼: " + data.error + "</p>";
           return;
         }

         renderSearchResult(data, words);
       })
       .catch(error => {
         finalizeLoadingState();
         document.getElementById("result").innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
         console.error("ã‚¨ãƒ©ãƒ¼:", error);
       });
    }

   // â–¼ Webå…¬é–‹CSV ã‹ã‚‰å–å¾—ã™ã‚‹æ–°æ–¹å¼ï¼ˆæ¤œç´¢å°‚ç”¨ãƒ»Excelæ›´æ–°æ—¥ã¯è§¦ã‚‰ãªã„ï¼‰
   function fetchFromCsv(words) {
     fetch(CSV_URL)
       .then(res => {
         if (!res.ok) {
           throw new Error("CSVã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
         }
         return res.text();
       })
       .then(csvText => {
         let data;
         try {
           data = convertCsvToJsonLikeApi(csvText); // { meta, data } ã®å½¢ã§è¿”ã‚‹
         } catch (e) {
           finalizeLoadingState();
           console.error("CSVå¤‰æ›ã‚¨ãƒ©ãƒ¼:", e);
           document.getElementById("result").innerHTML =
             "<p>CSVãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»•æ§˜å¤‰æ›´ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>"; 
           return;
         }

         if (!data || !Array.isArray(data.data)) {
           finalizeLoadingState();
           document.getElementById("result").innerHTML =
             "<p>CSVãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚</p>";
           return;
         }

         finalizeLoadingState();
         renderSearchResult(data, words);
       })
       .catch(err => {
         finalizeLoadingState();
         console.error("CSVãƒ¢ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", err);
         document.getElementById("result").innerHTML =
           "<p>CSVï¼ˆWebå…¬é–‹ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
       });
   }


   // â–¼ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™å…±é€šå‡¦ç†
   function finalizeLoadingState() {
     document.getElementById("loading").style.display = "none";
     document.getElementById("searchInput").disabled = false;
     document.getElementById("searchButton").disabled = false;
   }

   // â–¼ API / CSV å…±é€šã®æç”»å‡¦ç†ï¼ˆå…ƒã® fetchData å†…ã®å¾ŒåŠéƒ¨åˆ†ã‚’ãã®ã¾ã¾ç§»æ¤ï¼‰
   function renderSearchResult(data, words) {
    
     let resultTable = "";

     const columns = ["i", "y", "r", "f", "z"];
     columns.forEach(key => {
       resultTable += `<label><input type='checkbox' id='toggle${key}' onchange='toggleColumn("${key}")'> ${displayLabelMap[key]}</label>`;
     });

     resultTable += "<table border='1'><tr>";
     resultTable += `<th class='optional i' style='display:none;'>${displayLabelMap["i"]}</th>`;
     resultTable += `<th class='optional y' style='display:none;'>${displayLabelMap["y"]}</th>`;
     resultTable += `<th>${displayLabelMap["p"]}</th>`;
     resultTable += `<th>${displayLabelMap["s"]}</th>`;
     resultTable += `<th>${displayLabelMap["u1"]}</th>`;
     resultTable += `<th class='optional r' style='display:none;'>${displayLabelMap["r"]}</th>`;
     resultTable += `<th class='optional f' style='display:none;'>${displayLabelMap["f"]}</th>`;
     resultTable += `<th class='optional z' style='display:none;'>${displayLabelMap["z"]}</th>`;
     resultTable += `<th>${displayLabelMap["q"]}</th>`;
     resultTable += `<th>${displayLabelMap["u2"]}</th>`;
     resultTable += "</tr>";

     const filteredData = data.data.filter(item =>
       words.every(word =>
         Object.values(item).some(value =>
           normalizeText(value.toString()).includes(word)
         )
       )
     );

     if (filteredData.length === 0) {
       document.getElementById("result").innerHTML = "<p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
       return;
     }

     filteredData.forEach(item => {
       const updateClass = getUpdateClass(item["u2"]);
       const changeClass = getUpdateClass(item["u1"]);
       resultTable += "<tr>";
       resultTable += `<td class='optional i' style='display:none;'>${item["i"] || ""}</td>`;
       resultTable += `<td class='optional y' style='display:none;'>${item["y"] || ""}</td>`;
       resultTable += `<td class='p-name' data-yj='${item["y"] || ""}'>${item["p"] || ""}</td>`;
       resultTable += `<td style='${getStatusColor(item["s"])}'>${item["s"] || ""}</td>`;
       resultTable += `<td class='${changeClass}'>${formatShortDate(item["u1"])}</td>`;
       resultTable += `<td class='optional r' style='display:none;'>${item["r"] || ""}</td>`;
       resultTable += `<td class='optional f' style='display:none;'>${item["f"] || ""}</td>`;
       resultTable += `<td class='optional z' style='display:none;'>${item["z"] || ""}</td>`;
       resultTable += `<td>${item["q"] || ""}</td>`;
       resultTable += `<td class='${updateClass}'>${formatShortDate(item["u2"])}</td>`;
       resultTable += "</tr>";
     });

     resultTable += "</table>";
     document.getElementById("result").innerHTML = resultTable;
   }


   // â–¼ CSV â†’ æ—¢å­˜JSONå½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Œæˆç‰ˆï¼‰
   function convertCsvToJsonLikeApi(csvText) {
     // ---- 1) CSVæ–‡å­—åˆ—ã‚’2æ¬¡å…ƒé…åˆ— rows ã«å¤‰æ› ----
     function parseCsv(text) {
       const rows = [];
       let row = [];
       let cur = "";
       let inQuotes = false;

       for (let i = 0; i < text.length; i++) {
         const c = text[i];

         if (inQuotes) {
           if (c === '"') {
             // é€£ç¶šã™ã‚‹ "" ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸ1ã¤ã® "
             if (text[i + 1] === '"') {
               cur += '"';
               i++;
             } else {
               inQuotes = false;
             }
           } else {
             cur += c;
           }
         } else {
            if (c === '"') {
             inQuotes = true;
           } else if (c === ",") {
             row.push(cur);
             cur = "";
           } else if (c === "\r") {
             // ç„¡è¦–ï¼ˆ\r\n å¯¾å¿œï¼‰
             continue;
           } else if (c === "\n") {
             row.push(cur);
             rows.push(row);
             row = [];
             cur = "";
           } else {
             cur += c;
           }
         }
       }

       // æœ€çµ‚è¡ŒãŒæ”¹è¡Œã§çµ‚ã‚ã£ã¦ã„ãªã„å ´åˆã®ã‚±ã‚¢
       if (cur.length > 0 || row.length > 0) {
         row.push(cur);
         rows.push(row);
       }

       return rows;
     }

     const rows = parseCsv(csvText);

     // ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå°‘ãªã™ãã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
     if (!rows || rows.length < 3) {
       console.error("CSVã®è¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
       return { error: "CSVã®è¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚", data: [] };
     }

     // ---- 2) 2è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦å–å¾—ï¼ˆGASç‰ˆã¨åŒã˜å‰æï¼‰ ----
     const headers = rows[1].map(h => h.toString().trim());

     // ---- 3) ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œç´¢ç”¨ãƒãƒƒãƒ—ï¼ˆGASã® saveLightJsonToDrive ã¨åŒã˜ï¼‰----
     const headerMap = {
       i:  { keywords: ["æˆåˆ†å"] },
       y:  { keywords: ["YJã‚³ãƒ¼ãƒ‰"] },
       p:  { keywords: ["å“å"] },
       s:  { keywords: ["å‡ºè·å¯¾å¿œ"] },
       u1: { keywords: ["æ›´æ–°"], exclude: ["ä»¥å¤–"] }, // â‘¬: ã€Œä»¥å¤–ã€ãŒå…¥ã‚‰ãªã„ã»ã†
       r:  { keywords: ["ç†ç”±"] },
       f:  { keywords: ["å‡ºè·åœæ­¢", "è¦‹è¾¼ã¿"], exclude: ["æ™‚æœŸ"] },
       z:  { keywords: ["å‡ºè·åœæ­¢", "è¦‹è¾¼ã¿", "æ™‚æœŸ"] },
       q:  { keywords: ["å‡ºè·é‡", "çŠ¶æ³"] },
       u2: { keywords: ["æ›´æ–°", "ä»¥å¤–"] } // â‘³: ã€Œä»¥å¤–ã€ãŒå…¥ã‚‹ã»ã†
     };

     // ---- 4) ãƒ˜ãƒƒãƒ€ãƒ¼ä½ç½®ã‚’ç‰¹å®š ----
     const indexes = {};
     Object.entries(headerMap).forEach(([key, def]) => {
       const keywords = def.keywords || [];
       const exclude  = def.exclude  || [];
       const idx = headers.findIndex(h =>
         keywords.every(k => h.includes(k)) &&
         exclude.every(k => !h.includes(k))
       );
       if (idx !== -1) {
         indexes[key] = idx;
       } else {
         console.warn(`ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œ${key}ã€ã«è©²å½“ã™ã‚‹åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:`, def, headers);
       }
     });

     if (Object.keys(indexes).length !== Object.keys(headerMap).length) {
       // GASç‰ˆã¨åŒæ§˜ã€ã€Œä»•æ§˜å¤‰æ›´ã®å¯èƒ½æ€§ã€ã¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
       throw new Error("å¿…è¦ãªãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸€éƒ¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»•æ§˜å¤‰æ›´ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
     }

     // ---- 5) ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ï¼ˆ3è¡Œç›®ä»¥é™ï¼‰ã‚’ JSON é…åˆ—ã«å¤‰æ› ----
     const dataRows = rows.slice(2); // 0:ã‚¿ã‚¤ãƒˆãƒ«è¡Œ, 1:ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ, 2ã€œ:ãƒ‡ãƒ¼ã‚¿

     const records = dataRows
       // å…¨ã‚»ãƒ«ãŒç©ºã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
       .filter(row => row && row.some(cell => cell !== ""))
       .map(row => {
         const obj = {};
         Object.entries(indexes).forEach(([key, idx]) => {
           obj[key] = (row[idx] !== undefined && row[idx] !== null) ? row[idx] : "";
         });
         return obj;
       });

     // ---- 6) meta æƒ…å ±ã‚’æ§‹ç¯‰ ----
     // Excelæ›´æ–°æ—¥ãã®ã‚‚ã®ã¯ã€ã“ã‚Œã¾ã§é€šã‚Š API å´ã§ç®¡ç†ã™ã‚‹æ–¹é‡ãªã®ã§ã€
     // ã“ã“ã§ã¯ç©ºæ–‡å­—ã‚’å…¥ã‚Œã¦ãŠãã€render å´ã§ã¯ã€Œä¸æ˜ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
     const meta = {
       ä½œæˆæ—¥æ™‚: new Date().toISOString(),
       Excelæ›´æ–°æ—¥: "",           // â† ã“ã“ã¯ API å´ã‹ã‚‰ã® meta ã‚’ä»Šå¾Œçµ±åˆã™ã‚‹ä½™åœ°ã‚ã‚Š
       æŠ½å‡ºä»¶æ•°: records.length,
       åˆ—æ•°: Object.keys(indexes).length
     };

     return { meta, data: records };
    }



    function getUpdateClass(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      const now = new Date();
      const diffDays = (now - date) / (1000 * 60 * 60 * 24);
      const diffYears = diffDays / 365;
      if (diffDays <= 30) return "new-update";
      if (diffYears >= 2) return "old-update-2y";
      if (diffYears >= 1) return "old-update-1y";
      return "";
    }

    function formatUpdateDate(dateStr) {
      if (!dateStr) return "ä¸æ˜";
      const date = new Date(dateStr);
      return date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥";
    }

    function formatShortDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return String(date.getFullYear()).slice(-2) + "/" +
            ("0" + (date.getMonth() + 1)).slice(-2) + "/" +
            ("0" + date.getDate()).slice(-2);
    }

    function getStatusColor(status) {
      if (!status) return "";
      if (status.includes("ä¾›çµ¦åœæ­¢")) return "background-color: #ff6666; color: white;";
      if (status.includes("é™å®šå‡ºè·")) return "background-color: #ffff99; color: black;";
      return "";
    }

    function toggleColumn(key) {
      const show = document.getElementById("toggle" + key).checked;
      document.querySelectorAll("." + key).forEach(cell => {
        cell.style.display = show ? "" : "none";
      });
    }

    function setupEnterKey() {
      document.getElementById("searchInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
          fetchData();
        }
      });
    }

    function switchTab(mode) {
      const searchTab = document.getElementById("search-tab");
      const adminTab = document.getElementById("admin-tab");

      if (mode === "admin") {
       searchTab.style.display = "none";
       adminTab.style.display = "block";
       initDataModeControls();  // â˜… è¿½åŠ  Webå…¬é–‹ç›´èª­ã¿ãƒ¢ãƒ¼ãƒ‰ä½µç”¨å®Ÿè£…ã®éš›ã«è¿½åŠ  
       fetchAdminContent();
      } else {
        searchTab.style.display = "block";
        adminTab.style.display = "none";
      }
    }

    function fetchAdminContent() {
      const url = "https://script.google.com/macros/s/AKfycby83H_iRaJHXw9RxBFpHqxTscsrsrno_ZwkH80jV6Xj-qVbKNzw84PvBMQ7_7NOcOXV/exec?mode=latestLog";

      fetch(url)
        .then(res => res.json())
       .then(data => {
         if (!data || data.error) {
           document.getElementById("admin-tab").innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${data?.error || "å–å¾—å¤±æ•—"}</p>`;
            return;
         }

          if (!Array.isArray(data.logs)) {
           document.getElementById("admin-tab").innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚</p>`;
           return;
          }

          const html = data.logs.map(log =>
           `<div class="log-line">ğŸ•’ ${log.timestamp}ï½œ<strong>${log.step}</strong>ï¼š${log.message}</div>`
         ).join("");

         document.getElementById("admin-log-area").innerHTML = `<div class="log-box">${html}</div>`;
       })
       .catch(err => {
         document.getElementById("admin-tab").innerHTML = `<p style="color:red;">å–å¾—å¤±æ•—: ${err}</p>`;
       });
    }

    function initDataModeControls() {
     const radios = document.querySelectorAll('input[name="dataMode"]');
     if (!radios.length) return;

     // åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
     radios.forEach(r => {
       if (useCsvMode && r.value === "csv") r.checked = true;
       if (!useCsvMode && r.value === "api") r.checked = true;

       r.addEventListener("change", () => {
         useCsvMode = (r.value === "csv");
         localStorage.setItem("useCsvMode", useCsvMode ? "true" : "false");
       });
     });
   }

    const initialYJCode = '<?= initialYJCode ?>';
    window.addEventListener('DOMContentLoaded', () => {
        // â˜… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«1å›ã ã‘ Excelæ›´æ–°æ—¥ã‚’å–å¾—
      initExcelUpdateDate();

      if (initialYJCode) {
        document.querySelector('#searchInput').value = initialYJCode;
        fetchData();  // è‡ªå‹•æ¤œç´¢å®Ÿè¡Œ
      }
      setupYJPrefixOpen(); // â† ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‹•ä½œã‚’æœ‰åŠ¹åŒ–
    });

    function setupYJPrefixOpen() {
      // #result å†…ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šå‹•çš„ã«å·®ã—æ›¿ã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚OK
      const container = document.getElementById('result');
      container.addEventListener('dblclick', (e) => {
        const cell = e.target.closest('td.p-name');
        if (!cell) return;
  
        const yjRaw = (cell.dataset.yj || '').replace(/\D/g, '');
        const prefix7 = yjRaw.slice(0, 7);
        if (prefix7.length !== 7) return; // 7æ¡ãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„
  
       // â˜… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ä½¿ã‚ãªã„å®‰å…¨ç‰ˆï¼ˆå…¨è§’ã‚„ä¸å¯è¦–æ–‡å­—ã®æ··å…¥ãƒªã‚¹ã‚¯å›é¿ï¼‰
       var base = 'https://script.google.com/macros/s/AKfycby83H_iRaJHXw9RxBFpHqxTscsrsrno_ZwkH80jV6Xj-qVbKNzw84PvBMQ7_7NOcOXV/exec';
       var url  = base + '?yj=' + encodeURIComponent(prefix7);

        window.open(url, '_blank', 'noopener');
      });
    }

  </script>
</head>

<body onload="setupEnterKey()">

  <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç”¨ã®ã‚¨ãƒªã‚¢ï¼šæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="search-tab">
    <h2>åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ã®æ¤œç´¢</h2>

    <p style="color: gray; font-size: 11px;">
      2025å¹´5æœˆ13æ—¥ã‹ã‚‰ã€åšåŠ´çœã®ã‚¨ã‚¯ã‚»ãƒ«å½¢å¼ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚<br>
      ã“ã®æ—¥ä»¥é™ã«ã€Œå‡ºè·çŠ¶æ³ã€ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã¯ã€Œ<strong>å¤‰æ›´æ—¥</strong>ã€ã«ã€ãã‚Œä»¥å¤–ã®æƒ…å ±ã®æ›´æ–°ã¯ã€Œ<strong>æ›´æ–°æ—¥</strong>ã€ã«æ—¥ä»˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
      2025å¹´5æœˆ13æ—¥ã‚ˆã‚Šå‰ã«æ›´æ–°ã•ã‚ŒãŸæƒ…å ±ï¼ˆå‡ºè·çŠ¶æ³ã‚’å«ã‚€ï¼‰ã¯ã€Œ<strong>æ›´æ–°æ—¥</strong>ã€ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€<strong>å¤‰æ›´æ—¥ãŒç©ºæ¬„ã§ã‚‚æœ€æ–°ã®å‡ºè·çŠ¶æ³ã¨ãªã‚Šã¾ã™ã€‚</strong>
    </p>
    
    <!-- â˜… ã“ã“ãŒæ–°ã—ãè¿½åŠ ã™ã‚‹æ›´æ–°æ—¥è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="excel-date-info" style="font-size: 15px; margin: 4px 0 8px;">
      åšåŠ´çœExcelã®ãƒ‡ãƒ¼ã‚¿æ—¥: èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <input type="text" id="searchInput" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button id="searchButton" onclick="fetchData()">æ¤œç´¢</button>
      </div>
      <!-- âœ… ç®¡ç†ãƒœã‚¿ãƒ³ï¼šã‚¿ãƒ–åˆ‡æ›¿ -->
      <button onclick="switchTab('admin')" style="padding: 6px 12px;">ç®¡ç†</button>
    </div>

    <p style="font-size: 12px; color: #444; margin-top: 6px;">
      <strong>è–¬å“åã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</strong>ã™ã‚‹ã¨ã€ãã®è–¬å“ã‚³ãƒ¼ãƒ‰ï¼ˆä¸Š7æ¡ï¼‰ã§æ¤œç´¢ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚
    </p>


    <p id="loading" class="loading">æ¤œç´¢ä¸­...</p>
    <div id="result"></div>
  </div>

  <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç”¨ã®ã‚¨ãƒªã‚¢ï¼šç®¡ç†ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="admin-tab" style="display:none; padding: 20px;">

    <h2>ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</h2>

   <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
      <button class="back-button" onclick="switchTab('search')">æ¤œç´¢ã«æˆ»ã‚‹</button>
   </div>

   <h3>ãƒ‡ãƒ¼ã‚¿å–å¾—æ–¹å¼</h3>
   <div id="data-mode-area" style="margin-bottom: 16px; font-size: 14px;">
     <label style="margin-right: 12px;">
       <input type="radio" name="dataMode" value="csv">
       CSVé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰
     </label>
     <label>
       <input type="radio" name="dataMode" value="api">
       APIãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
     </label>
     <div style="font-size: 11px; color: #555; margin-top: 4px;">
       â€»CSVã§ä¸å…·åˆã‚’æ„Ÿã˜ãŸå ´åˆã¯APIãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚
     </div>
   </div>


    <h3>ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ­ã‚°è¡¨ç¤º</h3>
    <div id="admin-log-area">èª­ã¿è¾¼ã¿ä¸­...</div>

    <h3 style="margin-top: 24px;">å‚ç…§ãƒšãƒ¼ã‚¸</h3>
    <p>
      ğŸ”— <a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/iryou/kouhatu-iyaku/04_00003.html" target="_blank">
      åšç”ŸåŠ´åƒçœ åŒ»ç™‚ç”¨åŒ»è–¬å“ã®ä¾›çµ¦çŠ¶æ³ï¼ˆå…¬å¼ãƒšãƒ¼ã‚¸ï¼‰
     </a>
   </p>
  </div>

</body>
</html>